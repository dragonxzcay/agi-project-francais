<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AGI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            background: #000;
            width: 100%; height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
            cursor: default;
        }

        #cinema-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: black;
            z-index: 1;
        }

        #main-player {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: contain;
            z-index: 1;
            display: block;
        }

        #start-prompt, #replay-prompt {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: black;
            color: white;
            display: flex; justify-content: center; align-items: center;
            z-index: 999;
            transition: opacity 0.5s ease;
            cursor: pointer;
        }
        
        #replay-prompt { display: none; background: rgba(0,0,0,0.9); }

        #rotate-prompt {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            color: white;
            display: none; 
            flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999;
            text-align: center;
        }

        .rotate-icon {
            font-size: 50px;
            margin-bottom: 20px;
            animation: rotateAnim 2s infinite;
        }

        .action-btn {
            border: 1px solid rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.8);
            padding: 20px 60px;
            font-size: 20px;
            letter-spacing: 4px;
            text-transform: uppercase;
            animation: textPulse 2s infinite;
        }

        #countdown-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: black;
            display: none;
            justify-content: center; align-items: center;
            z-index: 998;
            color: white;
            font-size: 150px;
            font-weight: bold;
            font-family: monospace;
            text-shadow: 0 0 30px cyan;
            cursor: none;
        }

        #interface-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 50;
            display: flex; justify-content: center; align-items: center;
            gap: 5vw;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .choice-btn {
            width: 25vw;
            min-width: 200px;
            cursor: pointer; 
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s ease;
        }

        #btn-a { filter: drop-shadow(0 0 5px rgba(0, 255, 255, 0.2)); }
        #btn-a:hover { 
            transform: scale(1.1); 
            filter: drop-shadow(0 0 25px rgba(0, 255, 255, 0.8)); 
        }

        #btn-b { filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.2)); }
        #btn-b:hover { 
            transform: scale(1.1); 
            filter: drop-shadow(0 0 25px rgba(255, 0, 0, 0.8)); 
        }

        #fade-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: black;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.5s ease;
        }

        @media screen and (orientation: portrait) {
            #rotate-prompt { display: flex; }
            #start-prompt, #cinema-screen { display: none; }
        }

        @keyframes rotateAnim { 0% { transform: rotate(0deg); } 25% { transform: rotate(-90deg); } 100% { transform: rotate(-90deg); } }
        @keyframes textPulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes floatLoop { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        @keyframes dangerLoop { 0% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(255,0,0,0.3)); } 50% { transform: scale(1.02); filter: drop-shadow(0 0 15px rgba(255,0,0,0.6)); } 100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(255,0,0,0.3)); } }
        @keyframes numberPop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }

        .anim-a { animation: slideUp 0.8s forwards, floatLoop 4s ease-in-out infinite 0.8s; }
        .anim-b { animation: slideUp 0.8s forwards 0.2s, dangerLoop 3s ease-in-out infinite 1s; }
        .num-anim { animation: numberPop 0.9s linear forwards; }

    </style>
</head>
<body>

    <div id="rotate-prompt">
        <div class="rotate-icon">↻</div>
        <div style="font-size: 20px; letter-spacing: 2px;">TOURNER L'APPAREIL</div>
    </div>

    <div id="cinema-screen">
        <video id="main-player" playsinline webkit-playsinline>
            <source src="assets/main.webm" type="video/webm">
        </video>

        <div id="start-prompt" ontouchstart="initSequence()" onclick="initSequence()">
            <div class="action-btn">[ INITIALISER L'AGI ]</div>
        </div>

        <div id="countdown-layer">3</div>

        <div id="replay-prompt" ontouchstart="location.reload()" onclick="location.reload()">
            <div class="action-btn">↻ REJOUER L'EXPÉRIENCE</div>
        </div>

        <div id="interface-layer">
            <img src="assets/end_a_button.png" class="choice-btn" id="btn-a" ontouchstart="chooseEnding('A')" onclick="chooseEnding('A')">
            <img src="assets/end_b_button.png" class="choice-btn" id="btn-b" ontouchstart="chooseEnding('B')" onclick="chooseEnding('B')">
        </div>

        <div id="fade-overlay"></div>
    </div>

    <script>
        const TRIGGER_TIME = 70;
        const LOOP_DURATION = 3; 

        const video = document.getElementById('main-player');
        const startScreen = document.getElementById('start-prompt');
        const countdownScreen = document.getElementById('countdown-layer');
        const replayScreen = document.getElementById('replay-prompt');
        const ui = document.getElementById('interface-layer');
        const fade = document.getElementById('fade-overlay');
        const btnA = document.getElementById('btn-a');
        const btnB = document.getElementById('btn-b');
        const cinemaScreen = document.getElementById('cinema-screen');

        let isMenuOpen = false;
        let isEndingPlaying = false;
        let isCreditsPlaying = false;
        let loopStart = 0;

        video.onerror = function() {
            if(video.src.includes('END') || video.src.includes('credits')) {
                alert("ERREUR VIDEO: Fichier introuvable sur GitHub.");
                fade.style.opacity = '0'; 
            }
        };

        function initSequence() {
            startScreen.style.display = 'none';
            countdownScreen.style.display = 'flex';
            document.body.style.cursor = 'none';

            const doc = document.documentElement;
            
            if (doc.requestFullscreen) {
                doc.requestFullscreen();
            } else if (doc.webkitRequestFullscreen) {
                doc.webkitRequestFullscreen();
            } else if (doc.msRequestFullscreen) {
                doc.msRequestFullscreen();
            } else if (cinemaScreen.webkitRequestFullscreen) {
                cinemaScreen.webkitRequestFullscreen();
            }

            runCountdown(3);
        }

        function runCountdown(num) {
            if (num < 0) {
                countdownScreen.style.display = 'none';
                video.play().catch(e => { console.log("Autoplay blocked"); });
                requestAnimationFrame(monitorTime);
                return;
            }

            countdownScreen.innerText = num === 0 ? "INITIALIZED" : num;
            countdownScreen.classList.remove('num-anim');
            void countdownScreen.offsetWidth; 
            countdownScreen.classList.add('num-anim');

            setTimeout(() => runCountdown(num - 1), 1000);
        }

        function monitorTime() {
            if (isEndingPlaying) {
                if (video.ended) { playCredits(); }
                else { requestAnimationFrame(monitorTime); }
                return;
            }
            if (isCreditsPlaying) {
                if (video.ended) { showReplay(); }
                else { requestAnimationFrame(monitorTime); }
                return;
            }
            if (!isMenuOpen) {
                if (video.currentTime >= TRIGGER_TIME || video.currentTime >= video.duration - 0.5) {
                    openMenu();
                }
            } else {
                if (video.currentTime >= video.duration || video.ended) {
                    video.currentTime = loopStart;
                    video.play();
                }
            }
            requestAnimationFrame(monitorTime);
        }

        function openMenu() {
            if (isMenuOpen) return;
            isMenuOpen = true;
            loopStart = video.duration - LOOP_DURATION;
            if (loopStart < 0) loopStart = 0;
            
            document.body.style.cursor = 'default';
            ui.style.opacity = '1';
            ui.style.pointerEvents = 'all';

            btnA.classList.add('anim-a');
            btnB.classList.add('anim-b');
        }

        function chooseEnding(type) {
            document.body.style.cursor = 'none';
            ui.style.display = 'none';
            ui.style.opacity = '0';
            ui.style.pointerEvents = 'none';
            isMenuOpen = false;
            
            let nextVideo = '';
            let color = '';

            if (type === 'A') {
                nextVideo = 'assets/final/END_A_FINAL.webm';
                color = 'white';
            } else {
                nextVideo = 'assets/final/END_B_FINAL.webm';
                color = 'black';
            }

            fade.style.backgroundColor = color;
            fade.style.opacity = '1';

            setTimeout(() => {
                video.src = nextVideo;
                video.load();
                
                const safetyTimer = setTimeout(() => {
                    if (fade.style.opacity == '1') {
                        fade.style.opacity = '0';
                        video.play();
                        isEndingPlaying = true;
                    }
                }, 3000);

                video.onloadeddata = () => {
                    clearTimeout(safetyTimer);
                    setTimeout(() => {
                        fade.style.opacity = '0';
                        setTimeout(() => {
                            video.play();
                            isEndingPlaying = true;
                        }, 1000); 
                    }, 500);
                };
            }, 1000);
        }

        function playCredits() {
            isEndingPlaying = false;
            fade.style.backgroundColor = 'black';
            fade.style.opacity = '1';

            setTimeout(() => {
                video.src = 'assets/credits.webm';
                video.load();

                const creditTimer = setTimeout(() => {
                    if (fade.style.opacity == '1') {
                        fade.style.opacity = '0';
                        video.play();
                        isCreditsPlaying = true;
                    }
                }, 3000);

                video.onloadeddata = () => {
                    clearTimeout(creditTimer);
                    setTimeout(() => {
                        fade.style.opacity = '0';
                        setTimeout(() => {
                            video.play();
                            isCreditsPlaying = true;
                        }, 1000); 
                    }, 500);
                }
            }, 1500);
        }

        function showReplay() {
            isCreditsPlaying = false;
            document.body.style.cursor = 'default';
            replayScreen.style.display = 'flex';
            setTimeout(() => { replayScreen.style.opacity = '1'; }, 50);
        }
    </script>
</body>
</html>
